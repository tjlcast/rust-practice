sequenceDiagram
    participant 用户
    participant 客户端
    participant 杭小助服务端
    participant 管理台
    participant chatbi算法
    participant sql分析器
    participant sql转换器
    participant sql执行器
    participant 智能图表渲染器

    %% 鉴权流程
    用户 ->> 客户端: 发起请求
    客户端 ->> 杭小助服务端: 鉴权请求
    alt 鉴权失败
        杭小助服务端 -->> 客户端: 返回失败
        客户端 -->> 用户: 屏蔽请求
    else 鉴权成功
        杭小助服务端 ->> 杭小助服务端: 获取场景权限
        杭小助服务端 ->> 杭小助服务端: 创建会话
        杭小助服务端 -->> 客户端: 返回成功
    end

    %% 问数流程
    用户 ->> 客户端: 发送问数请求
    客户端 ->> 杭小助服务端: 转发请求
    
    %% 请求处理流程
    杭小助服务端 ->> 杭小助服务端: 请求合法性检查
    杭小助服务端 ->> 管理台: 获取行为参数
    管理台 -->> 杭小助服务端: 返回参数
    杭小助服务端 ->> sql分析器: 提取查数维度
    sql分析器 -->> 杭小助服务端: 返回维度
    杭小助服务端 ->> chatbi算法: 获取执行SQL
    chatbi算法 -->> 杭小助服务端: 返回SQL
    杭小助服务端 ->> sql转换器: 适配数据源
    sql转换器 -->> 杭小助服务端: 返回转换后SQL

    %% SQL检查与执行
    loop 系统检查和SQL检查（try 3 times）
        杭小助服务端 ->> 杭小助服务端: 检查SQL
        alt 检查失败
            杭小助服务端 ->> 杭小助服务端: 修改SQL
        else 检查成功
            杭小助服务端 ->> sql执行器: 请求执行SQL
            sql执行器 ->> 数据库: 执行SQL
            数据库 ->> sql执行器: 返回数据
            sql执行器库 ->> 杭小助服务端: 返回数据
        end
    end
    
    sql执行器 -->> 杭小助服务端: 返回数据
    杭小助服务端 ->> 智能图表渲染器: 生成图表
    智能图表渲染器 -->> 杭小助服务端: 返回图表
    
    %% 结果返回
    杭小助服务端 ->> 客户端: 流式返回(SQL/数据/图表)
    客户端 ->> 用户: 展示结果